<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cashiering</title>
    <link rel="stylesheet" type="text/css" href="cashiering.css">
</head>
<body>
            <div class="input-group">
                <form method="post" action="" id="cashierForm" autocomplete="off">
                    <div class="container">
                        <label for="product">Enter Product Code</label>
                        <input type="text" id="productQR" name="productQR" placeholder="Enter your Product">
                        <label for="product">Enter Quantity</label>
                        <input type="text" id="quantity" name="quantity" value="1" placeholder="1">
                        <input type="submit" value="Add to cart">
                    </div>
                </form>
            </div>

            <div class="table-container">
            <table class="content-table">
                <thead>
                    <tr>
                        <th>Product ID</th>
                        <th>Product</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>

<div class="totals-container">
<div class="subtotal">
    <div class="total_sub">SubTotal:</div>
    <div class="sub_number" id="sub_total"></div>
</div>

<div class="perc_discnt">
    <div class="discount_perc">Discount %</div>
    <div class="disc_percnumb" id="disc_perc"></div>
    <input type="hidden" name="disc_perc" value="">
</div>

<div class="tax">
    <div class="tax_perc">Tax %</div>
    <div class="tax_percnumb" id="tax_perc"></div>
    <input type="number" name="tax_perc" value="0">
</div>

<div class="total">
    <h2 class="grand_ttl">Grand Total:</h2>
    <div class="total_numb" id="grand-total"></div>
    <input type="hidden" name="total" value="">
    <input type="hidden" name="amount_tendered" value="0">
    <input type="hidden" name="amount_change" value="0">
</div>

    <button id="popupButton" type="button">Settle Payment</button>
</div>

</body>

<script>
function fetchAndPopulateProducts(productID) {
    fetch('cashieringRetrieve.php?productID=' + productID)
        .then(response => response.json())
        .then(data => {
            const tableBody = document.querySelector('.content-table tbody');
            tableBody.innerHTML = '';

            data.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.pro_ID}</td>
                    <td>${product.pro_name}</td>
                    <td class="input-cell"><input type="number" value="${product.pro_quantity}"></td>
                    <td class="input-cell"><input type="number" value="${product.pro_price}" readonly></td>
                    <td class="input-cell"><input type="number" value="${product.pro_price * product.pro_quantity}" readonly></td>
                    <td class="input-cell">
                        <form method="post" action="">
                            <input type="hidden" name="product_id" value="${product.pro_ID}">
                            <button type="submit" onclick="refreshParent()">Remove</button>
                        </form>
                    </td>
                `;

                tableBody.appendChild(row);
            });

            // Update the grand total after populating the table
            updateGrandTotal();
        })
        .catch(error => console.error(error));
}

// Event listener for the form submission
document.querySelector('#cashierForm').addEventListener('submit', function (event) {
    event.preventDefault(); // Prevent the default form submission
    const productID = document.querySelector('#productQR').value;
    fetchAndPopulateProducts(productID); // Fetch products based on the entered Product ID
});

// Function to calculate the subtotal
function calculateSubtotal() {
    let subtotal = 0;
    const rows = document.querySelectorAll('.content-table tbody tr');
    rows.forEach(row => {
        const quantity = parseFloat(row.querySelector('.input-cell input[type="number"]').value);
        const unitPrice = parseFloat(row.querySelector('.input-cell input[type="number"][readonly]').value);
        subtotal += quantity * unitPrice;
    });
    return subtotal;
}

// Function to calculate discount
function calculateDiscount() {
    const discountPercentage = parseFloat(document.querySelector('#disc_perc').textContent);
    const subtotal = calculateSubtotal();
    return (subtotal * discountPercentage) / 100;
}

// Function to update the grand total
function updateGrandTotal() {
    const subtotal = calculateSubtotal();
    const discount = calculateDiscount();
    const taxPercentage = parseFloat(document.querySelector('#tax_perc').value); // Use 'value' to get the tax percentage
    const grandTotal = subtotal - discount + (subtotal * taxPercentage) / 100;
    document.querySelector('#grand-total').textContent = grandTotal.toFixed(2);
}

// Event listener for discount input
document.querySelector('input[name="disc_perc"]').addEventListener('input', () => {
    updateGrandTotal();
});

// Event listener for tax input
document.querySelector('input[name="tax_perc"]').addEventListener('input', () => {
    updateGrandTotal();
});

// Call the function to fetch and populate products
fetchAndPopulateProducts();
</script>

</html>
    